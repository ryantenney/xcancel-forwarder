<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X/Twitter ‚Üí xcancel Setup Wizard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/node-forge@1.3.1/dist/forge.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .progress-bar {
            background: #f0f0f0;
            height: 4px;
            position: relative;
        }

        .progress-fill {
            background: #667eea;
            height: 100%;
            transition: width 0.3s ease;
        }

        .content {
            padding: 40px;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        .step p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .option-group {
            margin-bottom: 30px;
        }

        .option-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .option {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .option.selected {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .option input[type="radio"] {
            margin-right: 10px;
        }

        .option h3 {
            color: #333;
            margin-bottom: 5px;
            font-size: 1.2em;
        }

        .option .desc {
            color: #666;
            font-size: 0.95em;
        }

        .option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .option.disabled:hover {
            border-color: #e0e0e0;
            background: #f5f5f5;
        }

        .option.disabled input[type="radio"] {
            cursor: not-allowed;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group .hint {
            font-size: 0.9em;
            color: #999;
            margin-top: 5px;
        }

        .conditional {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .conditional.visible {
            display: block;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        button {
            padding: 12px 30px;
            font-size: 1em;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-back {
            background: #f0f0f0;
            color: #333;
        }

        .btn-back:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .btn-next {
            background: #667eea;
            color: white;
        }

        .btn-next:hover:not(:disabled) {
            background: #5568d3;
        }

        .review-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .review-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .review-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .review-item:last-child {
            border-bottom: none;
        }

        .review-item .label {
            font-weight: 600;
            color: #666;
        }

        .review-item .value {
            color: #333;
        }

        .download-section {
            text-align: center;
            padding: 40px 0;
        }

        .download-section h2 {
            color: #333;
            margin-bottom: 30px;
        }

        .download-btn {
            background: #667eea;
            color: white;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 8px;
            text-decoration: none;
            display: inline-block;
            margin: 10px;
            transition: all 0.2s;
        }

        .download-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 20px 0;
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .copy-btn:hover {
            background: #5568d3;
        }

        .success-icon {
            font-size: 4em;
            color: #52c41a;
            margin-bottom: 20px;
        }

        .info-box {
            background: #e6f7ff;
            border-left: 4px solid #1890ff;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box.warning {
            background: #fffbe6;
            border-left-color: #faad14;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü¶Ö X/Twitter ‚Üí xcancel</h1>
            <p>Setup Wizard</p>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>

        <div class="content">
            <!-- Step 1: Welcome -->
            <div class="step active" id="step1">
                <h2>Welcome!</h2>
                <p>This wizard will help you configure your local network to transparently redirect all X/Twitter traffic to xcancel.com - a privacy-respecting Twitter frontend.</p>

                <div class="info-box">
                    <strong>What is xcancel?</strong><br>
                    A privacy-respecting Twitter/X frontend that lets you view tweets, threads, and profiles without tracking, ads, or supporting X's current management.
                </div>

                <p>We'll walk through:</p>
                <ul style="margin-left: 20px; line-height: 2;">
                    <li>Choosing your web server (nginx or Caddy)</li>
                    <li>Network configuration</li>
                    <li>SSL certificate setup</li>
                    <li>DNS configuration</li>
                </ul>

                <div class="buttons">
                    <button class="btn-back" disabled>Back</button>
                    <button class="btn-next" onclick="nextStep()">Get Started</button>
                </div>
            </div>

            <!-- Step 2: Web Server -->
            <div class="step" id="step2">
                <h2>Choose Web Server</h2>
                <p>Both options work perfectly - the difference is configuration complexity.</p>

                <div class="option-group">
                    <div class="option" onclick="selectOption('webServer', 'nginx', this)">
                        <input type="radio" name="webServer" value="nginx">
                        <div>
                            <h3>nginx</h3>
                            <p class="desc">Battle-tested, widely used, industry standard</p>
                        </div>
                    </div>

                    <div class="option selected" onclick="selectOption('webServer', 'caddy', this)">
                        <input type="radio" name="webServer" value="caddy" checked>
                        <div>
                            <h3>Caddy (Recommended)</h3>
                            <p class="desc">Modern, automatic HTTPS, 4-line config vs 27 lines</p>
                        </div>
                    </div>
                </div>

                <div class="buttons">
                    <button class="btn-back" onclick="prevStep()">Back</button>
                    <button class="btn-next" onclick="nextStep()">Next</button>
                </div>
            </div>

            <!-- Step 3: Networking -->
            <div class="step" id="step3">
                <h2>Network Configuration</h2>
                <p>How should the container connect to your network?</p>

                <div class="option-group">
                    <div class="option selected" onclick="selectOption('networking', 'bridge', this); toggleConditional('macvlanConfig', false)">
                        <input type="radio" name="networking" value="bridge" checked>
                        <div>
                            <h3>Bridge (Simple)</h3>
                            <p class="desc">Uses host's IP with port forwarding. Easier setup.</p>
                        </div>
                    </div>

                    <div class="option" onclick="selectOption('networking', 'macvlan', this); toggleConditional('macvlanConfig', true)">
                        <input type="radio" name="networking" value="macvlan">
                        <div>
                            <h3>Macvlan (Dedicated IP)</h3>
                            <p class="desc">Container gets its own IP on your LAN. Better for Pi-hole/dnsmasq.</p>
                        </div>
                    </div>
                </div>

                <div class="conditional" id="macvlanConfig">
                    <h3>Macvlan Configuration</h3>
                    <div class="form-group">
                        <label>Network Interface</label>
                        <input type="text" id="networkInterface" value="eth0" placeholder="e.g., eth0, ens33, enp3s0">
                        <div class="hint">Find with: ip link show (Linux) or ifconfig (macOS)</div>
                    </div>

                    <div class="form-group">
                        <label>LAN Subnet (CIDR)</label>
                        <input type="text" id="lanSubnet" value="192.168.1.0/24" placeholder="e.g., 192.168.1.0/24">
                    </div>

                    <div class="form-group">
                        <label>Gateway IP</label>
                        <input type="text" id="lanGateway" value="192.168.1.1" placeholder="e.g., 192.168.1.1">
                    </div>

                    <div class="form-group">
                        <label>Container IP Address</label>
                        <input type="text" id="serverIp" value="192.168.1.100" placeholder="e.g., 192.168.1.100">
                        <div class="hint">Choose a free IP on your LAN</div>
                    </div>
                </div>

                <div class="buttons">
                    <button class="btn-back" onclick="prevStep()">Back</button>
                    <button class="btn-next" onclick="nextStep()">Next</button>
                </div>
            </div>

            <!-- Step 4: SSL -->
            <div class="step" id="step4">
                <h2>SSL Configuration</h2>
                <p>SSL certificates allow HTTPS interception without browser warnings.</p>

                <div class="option-group">
                    <div class="option selected" onclick="selectOption('ssl', 'generate', this)">
                        <input type="radio" name="ssl" value="generate" checked>
                        <div>
                            <h3>üî• Generate in Browser (Easiest)</h3>
                            <p class="desc">Generate CA and certificates right here. No external tools needed!</p>
                        </div>
                    </div>

                    <div class="option" onclick="selectOption('ssl', 'mkcert', this)">
                        <input type="radio" name="ssl" value="mkcert">
                        <div>
                            <h3>mkcert (Recommended)</h3>
                            <p class="desc">Automatic CA and certificate generation. 3 commands to working HTTPS.</p>
                        </div>
                    </div>

                    <div class="option" onclick="selectOption('ssl', 'manual', this)">
                        <input type="radio" name="ssl" value="manual">
                        <div>
                            <h3>Manual OpenSSL</h3>
                            <p class="desc">Full control over certificate parameters. Advanced users.</p>
                        </div>
                    </div>

                    <div class="option" onclick="selectOption('ssl', 'skip', this)">
                        <input type="radio" name="ssl" value="skip">
                        <div>
                            <h3>Skip SSL (Not Recommended)</h3>
                            <p class="desc">HTTP-only redirect. HTTPS links will show browser warnings.</p>
                        </div>
                    </div>
                </div>

                <!-- Manual OpenSSL Configuration (shown when 'manual' is selected) -->
                <div id="manualOpensslOptions" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3>OpenSSL Configuration</h3>
                    <p style="margin-bottom: 15px;">Customize your CA and certificate parameters:</p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Country (C):</label>
                            <input type="text" id="opensslCountry" value="US" maxlength="2"
                                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">State/Province (ST):</label>
                            <input type="text" id="opensslState" value="Local"
                                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Locality/City (L):</label>
                            <input type="text" id="opensslLocality" value="Local"
                                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Organization (O):</label>
                            <input type="text" id="opensslOrg" value="xcancel-forwarder"
                                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Organizational Unit (OU):</label>
                            <input type="text" id="opensslOU" value="Local Network"
                                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Certificate Validity (days):</label>
                            <input type="number" id="opensslValidity" value="3650" min="1"
                                   style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                    </div>

                    <p style="margin-top: 15px; font-size: 0.9em; color: #666;">
                        These values will be used to generate ca.conf, csr.conf, and cert.conf files included in your download.
                        You'll use these with OpenSSL commands to create your certificates.
                    </p>
                </div>

                <div class="buttons">
                    <button class="btn-back" onclick="prevStep()">Back</button>
                    <button class="btn-next" onclick="nextStep()">Next</button>
                </div>
            </div>

            <!-- Step 4.5: Generate Certificates (only shown when 'generate' SSL selected) -->
            <div class="step" id="step4_5">
                <h2>Generate Certificates</h2>
                <p>Generate your CA and server certificates right here in your browser!</p>

                <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                    <h3>Certificate Generation Options</h3>
                    <p style="margin-bottom: 15px;">Choose how to handle the Certificate Authority (CA) private key:</p>

                    <div class="option-group">
                        <div class="option selected" onclick="selectOption('caKeyHandling', 'discard', this)">
                            <input type="radio" name="caKeyHandling" value="discard" checked>
                            <div>
                                <h3>üîí Security-Focused (Recommended)</h3>
                                <p class="desc">Discard CA private key after signing. More secure, but certificates can't be renewed.</p>
                            </div>
                        </div>

                        <div class="option" onclick="selectOption('caKeyHandling', 'keep', this)">
                            <input type="radio" name="caKeyHandling" value="keep">
                            <div>
                                <h3>üîÑ Keep CA Key</h3>
                                <p class="desc">Include CA private key in download. Allows certificate renewal, but you must keep the key secure.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Password protection for CA key (shown when 'keep' is selected) -->
                    <div id="caKeyPassword" style="display: none; margin-top: 15px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">üîê Password-Protect CA Key (Recommended):</label>
                        <input type="password" id="caKeyPasswordInput" placeholder="Enter password to encrypt CA key"
                               style="width: 100%; max-width: 400px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px;">
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #666;">
                            Leave empty to store unencrypted (not recommended). With a password, the key will be encrypted using AES-256.
                        </p>
                    </div>

                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Certificate Validity (years):</label>
                        <input type="number" id="certValidityYears" value="10" min="1" max="30"
                               style="width: 100px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <span style="margin-left: 10px; color: #666;">Certificates will be valid for this many years</span>
                    </div>

                    <button class="btn-primary" onclick="generateCertificates()"
                            style="margin-top: 15px; padding: 12px 30px; background: #2ecc71; color: white; border: none; border-radius: 6px; font-size: 1em; font-weight: 600; cursor: pointer;">
                        Generate Certificates
                    </button>

                    <div id="certGenStatus" style="margin-top: 15px; display: none;">
                        <div id="certGenProgress" style="margin-bottom: 10px;">
                            <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                                <div id="certGenProgressBar" style="background: #2ecc71; height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <p id="certGenProgressText" style="margin-top: 5px; text-align: center;">Initializing...</p>
                        </div>
                        <div id="certGenResult" style="padding: 15px; border-radius: 5px; display: none;"></div>
                    </div>
                </div>

                <div class="buttons">
                    <button class="btn-back" onclick="prevStep()">Back</button>
                    <button class="btn-next" onclick="nextStep()">Next</button>
                </div>
            </div>

            <!-- Step 5: DNS -->
            <div class="step" id="step5">
                <h2>DNS Configuration</h2>
                <p>How will you configure DNS to point twitter.com/x.com to your proxy?</p>

                <div class="option-group">
                    <div class="option selected" onclick="selectOption('dns', 'pihole', this)">
                        <input type="radio" name="dns" value="pihole" checked>
                        <div>
                            <h3>Pi-hole (Recommended)</h3>
                            <p class="desc">Network-wide ad blocking with DNS override capability.</p>
                        </div>
                    </div>

                    <div class="option" id="dnsmasqOption" onclick="selectDnsmasqOption(this)">
                        <input type="radio" name="dns" value="dnsmasq">
                        <div>
                            <h3>Included dnsmasq</h3>
                            <p class="desc">Run a DNS server container (requires macvlan networking).</p>
                        </div>
                    </div>

                    <div class="option" onclick="selectOption('dns', 'unifi', this)">
                        <input type="radio" name="dns" value="unifi">
                        <div>
                            <h3>UniFi/Ubiquiti</h3>
                            <p class="desc">UniFi Dream Machine or USG with custom DNS entries.</p>
                        </div>
                    </div>

                    <div class="option" onclick="selectOption('dns', 'router', this)">
                        <input type="radio" name="dns" value="router">
                        <div>
                            <h3>Router Built-in DNS</h3>
                            <p class="desc">Use your router's DNS override features.</p>
                        </div>
                    </div>

                    <div class="option" onclick="selectOption('dns', 'manual', this)">
                        <input type="radio" name="dns" value="manual">
                        <div>
                            <h3>Manual (Hosts File)</h3>
                            <p class="desc">Edit /etc/hosts on each device individually.</p>
                        </div>
                    </div>
                </div>

                <div class="buttons">
                    <button class="btn-back" onclick="prevStep()">Back</button>
                    <button class="btn-next" onclick="handleDnsNext()">Next</button>
                </div>
            </div>

            <!-- Step 5.5: Upstream DNS (only if dnsmasq selected) -->
            <div class="step" id="step5_5">
                <h2>Upstream DNS Provider</h2>
                <p>Choose which DNS servers dnsmasq should use for non-Twitter queries.</p>

                <div class="option-group">
                    <div class="option selected" onclick="selectOption('upstreamDns', 'cloudflare', this)">
                        <input type="radio" name="upstreamDns" value="cloudflare" checked>
                        <div>
                            <h3>Cloudflare (1.1.1.1)</h3>
                            <p class="desc">Privacy-focused, fast, no logging</p>
                        </div>
                    </div>

                    <div class="option" onclick="selectOption('upstreamDns', 'google', this)">
                        <input type="radio" name="upstreamDns" value="google">
                        <div>
                            <h3>Google (8.8.8.8)</h3>
                            <p class="desc">Reliable, widely used, good performance</p>
                        </div>
                    </div>

                    <div class="option" onclick="selectOption('upstreamDns', 'quad9', this)">
                        <input type="radio" name="upstreamDns" value="quad9">
                        <div>
                            <h3>Quad9 (9.9.9.9)</h3>
                            <p class="desc">Security-focused, blocks malware domains</p>
                        </div>
                    </div>

                    <div class="option" onclick="selectOption('upstreamDns', 'opendns', this)">
                        <input type="radio" name="upstreamDns" value="opendns">
                        <div>
                            <h3>OpenDNS (208.67.222.222)</h3>
                            <p class="desc">Content filtering options, parental controls</p>
                        </div>
                    </div>
                </div>

                <div class="buttons">
                    <button class="btn-back" onclick="prevStep()">Back</button>
                    <button class="btn-next" onclick="generateConfigs()">Review & Generate</button>
                </div>
            </div>

            <!-- Step 6: Review & Download -->
            <div class="step" id="step6">
                <h2>Review Configuration</h2>
                <p>Review your selections and download generated configs.</p>

                <div class="review-section">
                    <h3>Your Configuration</h3>
                    <div class="review-item">
                        <span class="label">Web Server:</span>
                        <span class="value" id="reviewWebServer"></span>
                    </div>
                    <div class="review-item">
                        <span class="label">Networking:</span>
                        <span class="value" id="reviewNetworking"></span>
                    </div>
                    <div class="review-item">
                        <span class="label">SSL:</span>
                        <span class="value" id="reviewSsl"></span>
                    </div>
                    <div class="review-item">
                        <span class="label">DNS:</span>
                        <span class="value" id="reviewDns"></span>
                    </div>
                </div>

                <div class="download-section">
                    <div class="success-icon">‚úì</div>
                    <h2>Configuration Generated!</h2>
                    <p>Download your customized configuration files below.</p>

                    <button class="download-btn" onclick="downloadAllAsZip()" style="background: #52c41a; font-size: 1.2em;">üì¶ Download All as ZIP</button>
                    <br><br>
                    <div style="opacity: 0.7;">
                        <small>Or download individually:</small><br>
                        <button class="download-btn" onclick="downloadEnvFile()">üìÑ .env</button>
                        <button class="download-btn" onclick="downloadDockerCompose()">üê≥ docker-compose</button>
                        <button class="download-btn" onclick="downloadInstructions()">üìã Instructions</button>
                    </div>
                </div>

                <div id="nextStepsSection"></div>

                <div class="buttons">
                    <button class="btn-back" onclick="prevStep()">Back</button>
                    <button class="btn-next" onclick="location.reload()">Start Over</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        const totalSteps = 8; // Including step 4.5 for cert generation and step 5.5 for upstream DNS
        const config = {
            webServer: 'caddy',
            networking: 'bridge',
            ssl: 'generate',
            dns: 'pihole',
            upstreamDns: 'cloudflare',
            caKeyHandling: 'discard'
        };

        function updateProgress() {
            const progress = ((currentStep - 1) / (totalSteps - 1)) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function showStep(step) {
            document.querySelectorAll('.step').forEach(el => el.classList.remove('active'));
            let stepId;
            if (step === 4.5) {
                stepId = 'step4_5';
            } else if (step === 5.5) {
                stepId = 'step5_5';
            } else {
                stepId = 'step' + step;
            }
            document.getElementById(stepId).classList.add('active');
            currentStep = step;
            updateProgress();
            window.scrollTo(0, 0);
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                // Handle step 4 going to step 4.5 if 'generate' SSL selected
                if (currentStep === 4 && config.ssl === 'generate') {
                    showStep(4.5);
                } else if (currentStep === 4.5) {
                    // Validate certificates were generated
                    if (!config.generatedCerts) {
                        alert('Please generate certificates before continuing, or go back and choose a different SSL option.');
                        return;
                    }
                    showStep(5);
                } else if (currentStep === 5 && config.dns === 'dnsmasq') {
                    // Handle step 5 going to step 5.5 if dnsmasq selected
                    showStep(5.5);
                } else if (currentStep === 5.5) {
                    // Handle step 5.5 going to step 6
                    showStep(6);
                } else {
                    showStep(currentStep + 1);
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                // Handle step 4.5 going back to step 4
                if (currentStep === 4.5) {
                    showStep(4);
                } else if (currentStep === 5.5) {
                    // Handle step 5.5 going back to step 5
                    showStep(5);
                } else if (currentStep === 5 && config.ssl === 'generate') {
                    // If on step 5 and generate SSL was selected, go back to step 4.5
                    showStep(4.5);
                } else if (currentStep === 6 && config.dns === 'dnsmasq') {
                    // If on step 6 and dnsmasq was selected, go back to step 5.5
                    showStep(5.5);
                } else if (currentStep === 6 && config.ssl === 'generate') {
                    // If on step 6 and generate SSL was selected, need to navigate through step 5 ‚Üí 4.5 ‚Üí 4
                    // Actually just go back to step 5, user can navigate from there
                    showStep(5);
                } else {
                    showStep(currentStep - 1);
                }
            }
        }

        function handleDnsNext() {
            // If dnsmasq is selected, go to upstream DNS step
            if (config.dns === 'dnsmasq') {
                showStep(5.5);
            } else {
                generateConfigs();
            }
        }

        function selectOption(key, value, element) {
            config[key] = value;

            // Update UI
            const parent = element.parentElement;
            parent.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');

            // Update radio
            element.querySelector('input[type="radio"]').checked = true;

            // Show/hide manual OpenSSL options (cert generation is now a separate step)
            if (key === 'ssl') {
                const manualOpensslOptions = document.getElementById('manualOpensslOptions');

                if (value === 'manual') {
                    manualOpensslOptions.style.display = 'block';
                } else {
                    manualOpensslOptions.style.display = 'none';
                }
            }

            // Show/hide CA key password field
            if (key === 'caKeyHandling') {
                const caKeyPassword = document.getElementById('caKeyPassword');
                if (value === 'keep') {
                    caKeyPassword.style.display = 'block';
                } else {
                    caKeyPassword.style.display = 'none';
                }
            }

            // Enable/disable dnsmasq option based on networking
            if (key === 'networking') {
                const dnsmasqOption = document.getElementById('dnsmasqOption');
                if (value === 'macvlan') {
                    dnsmasqOption.classList.remove('disabled');
                    dnsmasqOption.querySelector('input').disabled = false;
                } else {
                    dnsmasqOption.classList.add('disabled');
                    dnsmasqOption.querySelector('input').disabled = true;
                    // If dnsmasq is currently selected, switch to pihole
                    if (config.dns === 'dnsmasq') {
                        const piholeOption = document.querySelector('.option input[value="pihole"]').parentElement.parentElement;
                        selectOption('dns', 'pihole', piholeOption);
                    }
                }
            }
        }

        function selectDnsmasqOption(element) {
            // Only allow selection if macvlan is enabled
            if (config.networking === 'macvlan') {
                selectOption('dns', 'dnsmasq', element);
            }
        }

        function toggleConditional(id, show) {
            const el = document.getElementById(id);
            if (show) {
                el.classList.add('visible');
            } else {
                el.classList.remove('visible');
            }
        }

        function generateConfigs() {
            // Capture form values
            if (config.networking === 'macvlan') {
                config.networkInterface = document.getElementById('networkInterface').value;
                config.lanSubnet = document.getElementById('lanSubnet').value;
                config.lanGateway = document.getElementById('lanGateway').value;
                config.serverIp = document.getElementById('serverIp').value;
            }

            // Update review
            document.getElementById('reviewWebServer').textContent = config.webServer;
            document.getElementById('reviewNetworking').textContent = config.networking;
            document.getElementById('reviewSsl').textContent = config.ssl;
            document.getElementById('reviewDns').textContent = config.dns;

            // Generate next steps
            generateNextSteps();

            nextStep();
        }

        // Certificate generation function
        async function generateCertificates() {
            const statusDiv = document.getElementById('certGenStatus');
            const progressDiv = document.getElementById('certGenProgress');
            const resultDiv = document.getElementById('certGenResult');
            const progressBar = document.getElementById('certGenProgressBar');
            const progressText = document.getElementById('certGenProgressText');

            // Show status
            statusDiv.style.display = 'block';
            progressDiv.style.display = 'block';
            resultDiv.style.display = 'none';

            try {
                const validityYears = parseInt(document.getElementById('certValidityYears').value) || 10;
                const keepCAKey = config.caKeyHandling === 'keep';

                // Step 1: Generate CA key pair
                progressBar.style.width = '10%';
                progressText.textContent = 'Generating CA key pair...';
                await sleep(100); // Allow UI to update

                const caKeys = forge.pki.rsa.generateKeyPair(2048);

                // Step 2: Create CA certificate
                progressBar.style.width = '30%';
                progressText.textContent = 'Creating CA certificate...';
                await sleep(100);

                const caCert = forge.pki.createCertificate();
                caCert.publicKey = caKeys.publicKey;
                caCert.serialNumber = '01';
                caCert.validity.notBefore = new Date();
                caCert.validity.notAfter = new Date();
                caCert.validity.notAfter.setFullYear(caCert.validity.notBefore.getFullYear() + validityYears);

                const caAttrs = [{
                    name: 'commonName',
                    value: 'xcancel-forwarder Root CA'
                }, {
                    name: 'countryName',
                    value: 'US'
                }, {
                    shortName: 'ST',
                    value: 'Local'
                }, {
                    name: 'localityName',
                    value: 'Local'
                }, {
                    name: 'organizationName',
                    value: 'xcancel-forwarder'
                }, {
                    shortName: 'OU',
                    value: 'Local Network'
                }];

                caCert.setSubject(caAttrs);
                caCert.setIssuer(caAttrs);

                caCert.setExtensions([{
                    name: 'basicConstraints',
                    cA: true
                }, {
                    name: 'keyUsage',
                    keyCertSign: true,
                    digitalSignature: true,
                    nonRepudiation: true,
                    keyEncipherment: true,
                    dataEncipherment: true
                }, {
                    name: 'subjectKeyIdentifier'
                }]);

                // Self-sign CA
                caCert.sign(caKeys.privateKey, forge.md.sha256.create());

                // Step 3: Generate server key pair
                progressBar.style.width = '50%';
                progressText.textContent = 'Generating server key pair...';
                await sleep(100);

                const serverKeys = forge.pki.rsa.generateKeyPair(2048);

                // Step 4: Create server certificate
                progressBar.style.width = '70%';
                progressText.textContent = 'Creating server certificate...';
                await sleep(100);

                const serverCert = forge.pki.createCertificate();
                serverCert.publicKey = serverKeys.publicKey;
                serverCert.serialNumber = '02';
                serverCert.validity.notBefore = new Date();
                serverCert.validity.notAfter = new Date();
                serverCert.validity.notAfter.setFullYear(serverCert.validity.notBefore.getFullYear() + validityYears);

                const serverAttrs = [{
                    name: 'commonName',
                    value: 'twitter.com'
                }, {
                    name: 'countryName',
                    value: 'US'
                }, {
                    shortName: 'ST',
                    value: 'Local'
                }, {
                    name: 'localityName',
                    value: 'Local'
                }, {
                    name: 'organizationName',
                    value: 'xcancel-forwarder'
                }];

                serverCert.setSubject(serverAttrs);
                serverCert.setIssuer(caAttrs);

                serverCert.setExtensions([{
                    name: 'basicConstraints',
                    cA: false
                }, {
                    name: 'keyUsage',
                    digitalSignature: true,
                    keyEncipherment: true
                }, {
                    name: 'extKeyUsage',
                    serverAuth: true
                }, {
                    name: 'subjectAltName',
                    altNames: [{
                        type: 2, // DNS
                        value: 'twitter.com'
                    }, {
                        type: 2,
                        value: '*.twitter.com'
                    }, {
                        type: 2,
                        value: 'x.com'
                    }, {
                        type: 2,
                        value: '*.x.com'
                    }, {
                        type: 2,
                        value: 't.co'
                    }, {
                        type: 2,
                        value: '*.t.co'
                    }]
                }, {
                    name: 'subjectKeyIdentifier'
                }]);

                // Sign server cert with CA
                serverCert.sign(caKeys.privateKey, forge.md.sha256.create());

                // Step 5: Convert to PEM format
                progressBar.style.width = '90%';
                progressText.textContent = 'Converting to PEM format...';
                await sleep(100);

                // Store certificates in config
                let caKeyPem = null;
                let caKeyEncrypted = false;
                if (keepCAKey) {
                    const password = document.getElementById('caKeyPasswordInput').value;
                    if (password && password.trim() !== '') {
                        // Encrypt CA key with password using AES-256
                        caKeyPem = forge.pki.encryptRsaPrivateKey(caKeys.privateKey, password, {
                            algorithm: 'aes256',
                            count: 10000, // PBKDF2 iterations
                            saltSize: 128 / 8
                        });
                        caKeyEncrypted = true;
                    } else {
                        // Store unencrypted
                        caKeyPem = forge.pki.privateKeyToPem(caKeys.privateKey);
                        caKeyEncrypted = false;
                    }
                }

                config.generatedCerts = {
                    caCert: forge.pki.certificateToPem(caCert),
                    caKey: caKeyPem,
                    caKeyEncrypted: caKeyEncrypted,
                    serverCert: forge.pki.certificateToPem(serverCert),
                    serverKey: forge.pki.privateKeyToPem(serverKeys.privateKey),
                    // Create bundle (server cert + CA cert for chain)
                    bundle: forge.pki.certificateToPem(serverCert) + forge.pki.certificateToPem(caCert)
                };

                // Complete
                progressBar.style.width = '100%';
                progressText.textContent = 'Complete!';
                await sleep(500);

                // Show result
                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#d4edda';
                resultDiv.style.border = '1px solid #c3e6cb';
                resultDiv.style.color = '#155724';

                const expiryDate = serverCert.validity.notAfter.toLocaleDateString();
                let caKeyStatus = '';
                if (keepCAKey) {
                    if (config.generatedCerts.caKeyEncrypted) {
                        caKeyStatus = '<strong>Included and password-protected</strong> with AES-256 encryption';
                    } else {
                        caKeyStatus = '<strong>Included but unencrypted</strong> (consider using a password next time)';
                    }
                } else {
                    caKeyStatus = '<strong>Discarded</strong> (certificates cannot be renewed, but more secure)';
                }

                let resultHTML = `
                    <h4 style="margin-top: 0;">‚úì Certificates Generated Successfully!</h4>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Root CA certificate created</li>
                        <li>Server certificate created for twitter.com, x.com, t.co (and wildcards)</li>
                        <li>Valid until: ${expiryDate}</li>
                        <li>CA private key: ${caKeyStatus}</li>
                    </ul>
                    <p style="margin-top: 10px;"><strong>Next:</strong> The certificates will be included in your download. You'll need to install the CA certificate (ca.crt) on your devices. See INSTALL_CA.md for instructions.</p>
                `;

                resultDiv.innerHTML = resultHTML;

            } catch (error) {
                console.error('Certificate generation error:', error);
                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';
                resultDiv.style.background = '#f8d7da';
                resultDiv.style.border = '1px solid #f5c6cb';
                resultDiv.style.color = '#721c24';
                resultDiv.innerHTML = `
                    <h4 style="margin-top: 0;">‚úó Error Generating Certificates</h4>
                    <p>${error.message}</p>
                    <p>Please try again or use mkcert/manual OpenSSL instead.</p>
                `;
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function generateOpensslConfigs() {
            const country = document.getElementById('opensslCountry').value || 'US';
            const state = document.getElementById('opensslState').value || 'Local';
            const locality = document.getElementById('opensslLocality').value || 'Local';
            const org = document.getElementById('opensslOrg').value || 'xcancel-forwarder';
            const ou = document.getElementById('opensslOU').value || 'Local Network';
            const validity = document.getElementById('opensslValidity').value || '3650';

            const caConf = `# CA Configuration
[ req ]
default_bits = 2048
prompt = no
default_md = sha256
distinguished_name = dn
x509_extensions = v3_ca

[ dn ]
C = ${country}
ST = ${state}
L = ${locality}
O = ${org}
OU = ${ou}
CN = xcancel-forwarder Root CA

[ v3_ca ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer:always
basicConstraints = critical,CA:TRUE
keyUsage = critical,digitalSignature,cRLSign,keyCertSign
`;

            const csrConf = `# CSR Configuration
[ req ]
default_bits = 2048
prompt = no
default_md = sha256
distinguished_name = dn
req_extensions = v3_req

[ dn ]
C = ${country}
ST = ${state}
L = ${locality}
O = ${org}
CN = twitter.com

[ v3_req ]
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = twitter.com
DNS.2 = *.twitter.com
DNS.3 = x.com
DNS.4 = *.x.com
DNS.5 = t.co
DNS.6 = *.t.co
`;

            const certConf = `# Certificate Signing Configuration
basicConstraints = CA:FALSE
keyUsage = digitalSignature,keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = twitter.com
DNS.2 = *.twitter.com
DNS.3 = x.com
DNS.4 = *.x.com
DNS.5 = t.co
DNS.6 = *.t.co
`;

            return {
                validity: validity,
                caConf: caConf,
                csrConf: csrConf,
                certConf: certConf
            };
        }

        function generateEnvFile() {
            let content = '# X/Twitter ‚Üí xcancel Configuration\n';
            content += '# Generated by setup wizard\n\n';
            content += '# Timezone\n';
            content += 'TZ=America/New_York\n\n';

            if (config.networking === 'macvlan') {
                content += '# Macvlan Networking\n';
                content += `NETWORK_INTERFACE=${config.networkInterface}\n`;
                content += `LAN_SUBNET=${config.lanSubnet}\n`;
                content += `LAN_GATEWAY=${config.lanGateway}\n\n`;

                if (config.webServer === 'nginx') {
                    content += `NGINX_IP=${config.serverIp}\n`;
                } else {
                    content += `CADDY_IP=${config.serverIp}\n`;
                }

                if (config.dns === 'dnsmasq') {
                    const parts = config.serverIp.split('.');
                    const dnsmasqIp = parts.slice(0, 3).join('.') + '.' + (parseInt(parts[3]) + 1);
                    content += `DNSMASQ_IP=${dnsmasqIp}\n`;
                    content += 'UPSTREAM_DNS=1.1.1.1\n';
                }
            } else {
                content += '# Bridge Networking\n';
                content += 'HTTP_PORT=80\n';
                content += 'HTTPS_PORT=443\n';
            }

            return content;
        }

        function generateDnsmasqConf() {
            const serverIp = config.serverIp;

            // Get upstream DNS servers based on selection
            let upstreamDns;
            switch (config.upstreamDns) {
                case 'google':
                    upstreamDns = ['8.8.8.8', '8.8.4.4'];
                    break;
                case 'quad9':
                    upstreamDns = ['9.9.9.9', '149.112.112.112'];
                    break;
                case 'opendns':
                    upstreamDns = ['208.67.222.222', '208.67.220.220'];
                    break;
                default: // cloudflare
                    upstreamDns = ['1.1.1.1', '1.0.0.1'];
            }

            let content = '# dnsmasq configuration for X/Twitter ‚Üí xcancel redirect\n';
            content += '# Generated by setup wizard\n\n';
            content += '# Listen on all interfaces\n';
            content += 'interface=*\n\n';
            content += '# Don\'t read /etc/resolv.conf or /etc/hosts\n';
            content += 'no-resolv\n';
            content += 'no-hosts\n\n';
            content += '# Upstream DNS servers\n';
            for (const dns of upstreamDns) {
                content += `server=${dns}\n`;
            }
            content += '\n# Cache size\n';
            content += 'cache-size=1000\n\n';
            content += '# DNS overrides - point X/Twitter domains to your proxy server\n';
            content += `address=/twitter.com/${serverIp}\n`;
            content += `address=/x.com/${serverIp}\n`;
            content += `address=/t.co/${serverIp}\n`;

            return content;
        }

        function generateDockerCompose() {
            const isCaddy = config.webServer === 'caddy';
            const isMacvlan = config.networking === 'macvlan';
            const includeDnsmasq = config.dns === 'dnsmasq';
            const serviceName = isCaddy ? 'caddy' : 'nginx';

            let content = 'version: "3.9"\n\n';

            // Header comments
            if (isCaddy) {
                content += '# Caddy alternative to nginx\n';
                content += '# Simpler configuration, automatic HTTP/2 and HTTP/3\n\n';
            }

            content += '# Network configuration\n';
            content += `# Generated with: ${config.networking} networking\n\n`;

            // Networks section
            content += 'networks:\n';
            if (isMacvlan) {
                content += '  macvlan_lan:\n';
                content += '    driver: macvlan\n';
                content += '    driver_opts:\n';
                content += `      parent: ${config.networkInterface}\n`;
                content += '    ipam:\n';
                content += '      config:\n';
                content += `        - subnet: ${config.lanSubnet}\n`;
                content += `          gateway: ${config.lanGateway}\n\n`;
            } else {
                content += '  default:\n';
                content += '    driver: bridge\n\n';
            }

            // Services section
            content += 'services:\n';
            content += `  ${serviceName}:\n`;
            if (isCaddy) {
                content += '    image: caddy:2-alpine\n';
                content += '    container_name: xcancel-caddy\n';
            } else {
                content += '    image: nginx:1.27-alpine\n';
                content += '    container_name: xcancel-nginx\n';
            }
            content += '    restart: unless-stopped\n\n';

            // Networking for service
            if (isMacvlan) {
                content += '    # Macvlan networking - dedicated IP\n';
                content += '    networks:\n';
                content += '      macvlan_lan:\n';
                content += `        ipv4_address: ${config.serverIp}\n\n`;
            } else {
                content += '    # Bridge networking - port forwarding\n';
                content += '    ports:\n';
                content += '      - "80:80"\n';
                content += '      - "443:443"\n';
                content += '      - "443:443/udp"  # HTTP/3 (QUIC)\n\n';
            }

            // Volumes
            content += '    volumes:\n';
            if (serviceName === 'nginx') {
                content += '      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro\n';
                content += '      - ./nginx/conf.d:/etc/nginx/conf.d:ro\n';
                content += '      - ./nginx/ssl:/etc/nginx/ssl:ro\n';
                content += '      - ./nginx/logs:/var/log/nginx\n';
            } else {
                content += '      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro\n';
                content += '      - ./caddy/ssl:/etc/caddy/ssl:ro\n';
                content += '      - caddy_data:/data\n';
                content += '      - caddy_config:/config\n';
            }

            // Environment
            content += '\n    environment:\n';
            content += '      - TZ=${TZ:-America/New_York}\n\n';

            // Health check
            content += '    healthcheck:\n';
            content += '      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]\n';
            content += '      interval: 30s\n';
            content += '      timeout: 3s\n';
            content += '      retries: 3\n\n';

            // Optional dnsmasq service
            if (includeDnsmasq) {
                if (!isMacvlan) {
                    content += '  # NOTE: dnsmasq requires macvlan networking\n';
                    content += '  # Current config uses bridge mode - dnsmasq will not work\n\n';
                } else {
                    const parts = config.serverIp.split('.');
                    const dnsmasqIp = parts.slice(0, 3).join('.') + '.' + (parseInt(parts[3]) + 1);

                    content += '  dnsmasq:\n';
                    content += '    image: jpillora/dnsmasq:latest\n';
                    content += '    container_name: xcancel-dnsmasq\n';
                    content += '    restart: unless-stopped\n';
                    content += '    networks:\n';
                    content += '      macvlan_lan:\n';
                    content += `        ipv4_address: ${dnsmasqIp}\n`;
                    content += '    volumes:\n';
                    content += '      - ./dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf:ro\n';
                    content += '    environment:\n';
                    content += '      - TZ=${TZ:-America/New_York}\n';
                    content += '    cap_add:\n';
                    content += '      - NET_ADMIN\n\n';
                }
            }

            // Volumes section for Caddy
            if (isCaddy) {
                content += 'volumes:\n';
                content += '  caddy_data:\n';
                content += '  caddy_config:\n';
            }

            return {
                filename: 'docker-compose.yaml',
                content: content
            };
        }

        function generateInstructions() {
            let content = '# X/Twitter ‚Üí xcancel Setup Instructions\n\n';
            content += '## Configuration Summary\n\n';
            content += `- Web Server: ${config.webServer}\n`;
            content += `- Networking: ${config.networking}\n`;
            content += `- SSL: ${config.ssl}\n`;
            content += `- DNS: ${config.dns}\n\n`;

            content += '## Next Steps\n\n';
            content += '### 1. Extract and Place Configuration Files\n\n';
            content += 'Extract the ZIP to your xcancel-forwarder directory, then:\n\n';
            content += '```bash\n';
            content += '# Rename env to .env (dot-files are hidden by default)\n';
            content += 'mv env .env\n';
            if (config.dns === 'dnsmasq' && config.networking === 'macvlan') {
                content += '\n# dnsmasq.conf is already in the dnsmasq/ directory\n';
            }
            content += '```\n\n';

            if (config.ssl === 'mkcert') {
                content += '### 2. Generate SSL Certificates\n\n';
                content += '```bash\n';
                content += 'brew install mkcert\n';
                content += 'mkcert -install\n';
                content += 'mkcert twitter.com x.com "*.twitter.com" "*.x.com" t.co "*.t.co"\n\n';
                content += `# Copy certificates to ${config.webServer}/ssl/\n`;
                content += `cp twitter.com+5.pem ${config.webServer}/ssl/twitter_bundle.pem\n`;
                content += `cp twitter.com+5-key.pem ${config.webServer}/ssl/twitter_key.pem\n`;
                content += '```\n\n';
                content += 'See docs/SSL_SETUP_MKCERT.md for detailed instructions.\n\n';
            } else if (config.ssl === 'manual') {
                content += '### 2. Generate SSL Certificates\n\n';
                content += 'Follow the manual OpenSSL guide:\n';
                content += 'See docs/SSL_SETUP.md for detailed instructions.\n\n';
            }

            const stepNum = config.ssl === 'skip' ? 2 : 3;
            content += `### ${stepNum}. Configure DNS\n\n`;

            const dnsGuides = {
                pihole: 'docs/PIHOLE_SETUP.md',
                unifi: 'docs/OTHER_DNS.md#unifi-ubiquiti',
                dnsmasq: 'docs/DNSMASQ_SETUP.md',
                router: 'docs/OTHER_DNS.md',
                manual: 'docs/OTHER_DNS.md#per-device-configuration-without-dns-server'
            };

            content += `Configure ${config.dns} to point twitter.com, x.com, and t.co to your proxy.\n\n`;
            content += `See ${dnsGuides[config.dns]} for instructions.\n\n`;

            content += `### ${stepNum + 1}. Start the Service\n\n`;
            content += '```bash\n';
            content += 'docker compose up -d\n';
            content += '```\n\n';

            content += `### ${stepNum + 2}. Test\n\n`;
            content += '```bash\n';
            content += './scripts/test-redirect.sh\n';
            content += '```\n\n';
            content += 'See docs/TESTING.md for detailed testing instructions.\n';

            return content;
        }

        function generateNextSteps() {
            const container = document.getElementById('nextStepsSection');
            let html = '<div class="info-box"><h3>Next Steps:</h3><ol style="margin-left: 20px; line-height: 2;">';

            html += `<li>Download the configuration files above (or download all as ZIP)</li>`;
            html += `<li>Extract to your xcancel-forwarder directory and rename <code>env</code> to <code>.env</code></li>`;

            if (config.ssl === 'mkcert') {
                html += '<li>Install mkcert and generate certificates (see instructions)</li>';
            } else if (config.ssl === 'manual') {
                html += '<li>Generate SSL certificates manually (see docs/SSL_SETUP.md)</li>';
            }

            html += `<li>Configure DNS to point domains to your proxy</li>`;
            html += `<li>Start the service with Docker Compose (see start command below)</li>`;
            html += '<li>Test the setup with ./scripts/test-redirect.sh</li>';
            html += '</ol></div>';

            container.innerHTML = html;
        }

        function downloadEnvFile() {
            const content = generateEnvFile();
            downloadFile('.env', content);
        }

        function downloadDockerCompose() {
            const { filename, content } = generateDockerCompose();
            downloadFile(filename, content);
        }

        function downloadInstructions() {
            const content = generateInstructions();
            downloadFile('SETUP_INSTRUCTIONS.md', content);
        }

        async function downloadAllAsZip() {
            const button = event.target;
            const originalText = button.innerHTML;

            try {
                // Show loading state
                button.innerHTML = '‚è≥ Creating ZIP...';
                button.disabled = true;

                const zip = new JSZip();
                const folder = zip.folder('xcancel-forwarder');

                // Add .env file
                const envContent = generateEnvFile();
                folder.file('.env', envContent);

                // Add docker-compose file
                const { filename, content } = generateDockerCompose();
                folder.file(filename, content);

                // Add web server configuration files
                if (config.webServer === 'nginx') {
                    // Add nginx config
                    const nginxConfig = `# Catches twitter/x hostnames and anything else (default_server) and 301s to xcancel.com
server {
    ssl_protocols TLSv1.2 TLSv1.3;

    listen 443 ssl;
    listen 80;
    http2 on;

    listen 443 quic reuseport;

    server_name twitter.com www.twitter.com x.com www.x.com t.co www.t.co _;

    ssl_certificate     /etc/nginx/ssl/twitter_bundle.pem;  # fullchain
    ssl_certificate_key /etc/nginx/ssl/twitter_key.pem;

    # quick TLS/session defaults
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 1d;

    add_header Alt-Svc 'h3=":443"; ma=86400' always;  # advertise HTTP/3
    add_header X-Protocol $server_protocol always;

    location / {
        return 301 https://xcancel.com$request_uri;
    }
}
`;
                    folder.file('nginx/conf.d/xcancel-redirect.conf', nginxConfig);

                    // Add SSL README
                    const sslReadme = `# SSL Certificates

Place your SSL certificates in this directory:

- \`twitter_bundle.pem\` - Full certificate chain (certificate + CA chain)
- \`twitter_key.pem\` - Private key

**IMPORTANT**: Never commit actual certificates or private keys to git!

## Required Files

Your nginx configuration expects:

- \`twitter_bundle.pem\` - Certificate + CA chain
- \`twitter_key.pem\` - Private key

## Setup Instructions

See the setup instructions for complete details on:

1. Creating a self-signed Certificate Authority
2. Generating certificates for twitter.com/x.com
3. Installing the CA on your devices
4. Placing certificates in this directory

## Security Note

The certificates in this directory allow your local nginx server to intercept HTTPS traffic to twitter.com and x.com domains. This only works because you've configured DNS on your network to point these domains to your nginx server, and you've installed your self-signed CA as a trusted root on your devices.

Without the DNS override, these certificates have no effect. Without the trusted CA, browsers will show security warnings.
`;
                    folder.file('nginx/ssl/README.md', sslReadme);

                    // Add generated certificates if available
                    if (config.ssl === 'generate' && config.generatedCerts) {
                        folder.file('nginx/ssl/twitter_bundle.pem', config.generatedCerts.bundle);
                        folder.file('nginx/ssl/twitter_key.pem', config.generatedCerts.serverKey);
                        folder.file('nginx/ssl/ca.crt', config.generatedCerts.caCert);
                        if (config.generatedCerts.caKey) {
                            folder.file('nginx/ssl/ca.key', config.generatedCerts.caKey);
                        }
                        // Add installation instructions
                        const installGuide = `# Installing the CA Certificate

The CA certificate (ca.crt) must be installed on each device that will access twitter.com through this proxy.

## macOS

1. Double-click \`ca.crt\`
2. Keychain Access will open
3. Find "xcancel-forwarder Root CA" in the list
4. Double-click it, expand "Trust"
5. Set "When using this certificate" to "Always Trust"
6. Close and enter your password

## iOS/iPadOS

1. Email \`ca.crt\` to yourself or use AirDrop
2. Tap the certificate file
3. Go to Settings ‚Üí General ‚Üí VPN & Device Management
4. Tap the profile and install it
5. Go to Settings ‚Üí General ‚Üí About ‚Üí Certificate Trust Settings
6. Enable the certificate

## Windows

1. Double-click \`ca.crt\`
2. Click "Install Certificate"
3. Choose "Current User"
4. Select "Place all certificates in the following store"
5. Click "Browse" and select "Trusted Root Certification Authorities"
6. Click Next and Finish

## Android

1. Copy \`ca.crt\` to your device
2. Go to Settings ‚Üí Security ‚Üí Encryption & credentials
3. Tap "Install a certificate"
4. Choose "CA certificate"
5. Select the \`ca.crt\` file

## Linux

### Debian/Ubuntu
\`\`\`bash
sudo cp ca.crt /usr/local/share/ca-certificates/xcancel-ca.crt
sudo update-ca-certificates
\`\`\`

### Fedora/RHEL
\`\`\`bash
sudo cp ca.crt /etc/pki/ca-trust/source/anchors/xcancel-ca.crt
sudo update-ca-trust
\`\`\`

## Firefox

Firefox uses its own certificate store:

1. Open Firefox
2. Go to Settings ‚Üí Privacy & Security
3. Scroll to "Certificates" and click "View Certificates"
4. Go to "Authorities" tab
5. Click "Import"
6. Select \`ca.crt\`
7. Check "Trust this CA to identify websites"
8. Click OK

## Verification

After installing, visit https://twitter.com - you should see no certificate warnings.
${config.generatedCerts.caKeyEncrypted ? `
## Using the Encrypted CA Key

The CA private key (ca.key) is **password-protected with AES-256 encryption**.

**To use it for certificate renewal:**

\`\`\`bash
# Decrypt the key (you'll be prompted for the password)
openssl rsa -in ca.key -out ca_decrypted.key

# Or use it directly with openssl (provide password when prompted)
openssl req -new -key ca.key -out new_cert.csr
\`\`\`

**Security note:** Keep this password safe! Without it, you cannot use the CA key to renew certificates. Store the password in a secure location like a password manager.
` : config.generatedCerts.caKey ? `
## CA Private Key Included (Unencrypted)

**Warning:** The CA private key (ca.key) is stored **unencrypted**. Anyone with access to this file can create certificates trusted by your devices.

**Security recommendations:**
- Store ca.key in a secure location with restricted permissions
- Consider deleting ca.key after distributing ca.crt to all devices if you don't need certificate renewal
- Use file permissions: \`chmod 600 ca.key\`
` : ''}
`;
                        folder.file('nginx/ssl/INSTALL_CA.md', installGuide);
                    }
                } else if (config.webServer === 'caddy') {
                    // Add Caddyfile
                    const caddyConfig = `# Caddy configuration for X/Twitter ‚Üí xcancel redirect
# Much simpler than nginx!

# Handle all Twitter/X domains
twitter.com, www.twitter.com, x.com, www.x.com, t.co, www.t.co {
	# Use custom SSL certificates
	# Comment out this line to skip HTTPS (HTTP-only redirect)
	tls /etc/caddy/ssl/twitter_bundle.pem /etc/caddy/ssl/twitter_key.pem

	# Redirect to xcancel, preserving the URI path
	redir https://xcancel.com{uri} permanent
}

# That's it! Caddy automatically handles:
# - HTTP/2 and HTTP/3 (QUIC)
# - Security headers
# - Logging
# - Graceful reloads
`;
                    folder.file('caddy/Caddyfile', caddyConfig);

                    // Add SSL README for Caddy
                    const sslReadme = `# SSL Certificates

Place your SSL certificates in this directory:

- \`twitter_bundle.pem\` - Full certificate chain (certificate + CA chain)
- \`twitter_key.pem\` - Private key

**IMPORTANT**: Never commit actual certificates or private keys to git!

## Required Files

Your Caddyfile expects:

- \`twitter_bundle.pem\` - Certificate + CA chain
- \`twitter_key.pem\` - Private key

## Setup Instructions

See the setup instructions for complete details on:

1. Creating a self-signed Certificate Authority
2. Generating certificates for twitter.com/x.com
3. Installing the CA on your devices
4. Placing certificates in this directory

## Security Note

The certificates in this directory allow your Caddy server to intercept HTTPS traffic to twitter.com and x.com domains. This only works because you've configured DNS on your network to point these domains to your Caddy server, and you've installed your self-signed CA as a trusted root on your devices.

Without the DNS override, these certificates have no effect. Without the trusted CA, browsers will show security warnings.
`;
                    folder.file('caddy/ssl/README.md', sslReadme);

                    // Add generated certificates if available
                    if (config.ssl === 'generate' && config.generatedCerts) {
                        folder.file('caddy/ssl/twitter_bundle.pem', config.generatedCerts.bundle);
                        folder.file('caddy/ssl/twitter_key.pem', config.generatedCerts.serverKey);
                        folder.file('caddy/ssl/ca.crt', config.generatedCerts.caCert);
                        if (config.generatedCerts.caKey) {
                            folder.file('caddy/ssl/ca.key', config.generatedCerts.caKey);
                        }
                        // Add installation instructions (same as nginx)
                        const installGuide = `# Installing the CA Certificate

The CA certificate (ca.crt) must be installed on each device that will access twitter.com through this proxy.

## macOS

1. Double-click \`ca.crt\`
2. Keychain Access will open
3. Find "xcancel-forwarder Root CA" in the list
4. Double-click it, expand "Trust"
5. Set "When using this certificate" to "Always Trust"
6. Close and enter your password

## iOS/iPadOS

1. Email \`ca.crt\` to yourself or use AirDrop
2. Tap the certificate file
3. Go to Settings ‚Üí General ‚Üí VPN & Device Management
4. Tap the profile and install it
5. Go to Settings ‚Üí General ‚Üí About ‚Üí Certificate Trust Settings
6. Enable the certificate

## Windows

1. Double-click \`ca.crt\`
2. Click "Install Certificate"
3. Choose "Current User"
4. Select "Place all certificates in the following store"
5. Click "Browse" and select "Trusted Root Certification Authorities"
6. Click Next and Finish

## Android

1. Copy \`ca.crt\` to your device
2. Go to Settings ‚Üí Security ‚Üí Encryption & credentials
3. Tap "Install a certificate"
4. Choose "CA certificate"
5. Select the \`ca.crt\` file

## Linux

### Debian/Ubuntu
\`\`\`bash
sudo cp ca.crt /usr/local/share/ca-certificates/xcancel-ca.crt
sudo update-ca-certificates
\`\`\`

### Fedora/RHEL
\`\`\`bash
sudo cp ca.crt /etc/pki/ca-trust/source/anchors/xcancel-ca.crt
sudo update-ca-trust
\`\`\`

## Firefox

Firefox uses its own certificate store:

1. Open Firefox
2. Go to Settings ‚Üí Privacy & Security
3. Scroll to "Certificates" and click "View Certificates"
4. Go to "Authorities" tab
5. Click "Import"
6. Select \`ca.crt\`
7. Check "Trust this CA to identify websites"
8. Click OK

## Verification

After installing, visit https://twitter.com - you should see no certificate warnings.
${config.generatedCerts.caKeyEncrypted ? `
## Using the Encrypted CA Key

The CA private key (ca.key) is **password-protected with AES-256 encryption**.

**To use it for certificate renewal:**

\`\`\`bash
# Decrypt the key (you'll be prompted for the password)
openssl rsa -in ca.key -out ca_decrypted.key

# Or use it directly with openssl (provide password when prompted)
openssl req -new -key ca.key -out new_cert.csr
\`\`\`

**Security note:** Keep this password safe! Without it, you cannot use the CA key to renew certificates. Store the password in a secure location like a password manager.
` : config.generatedCerts.caKey ? `
## CA Private Key Included (Unencrypted)

**Warning:** The CA private key (ca.key) is stored **unencrypted**. Anyone with access to this file can create certificates trusted by your devices.

**Security recommendations:**
- Store ca.key in a secure location with restricted permissions
- Consider deleting ca.key after distributing ca.crt to all devices if you don't need certificate renewal
- Use file permissions: \`chmod 600 ca.key\`
` : ''}
`;
                        folder.file('caddy/ssl/INSTALL_CA.md', installGuide);
                    }
                }

                // Add dnsmasq.conf if dnsmasq is selected
                if (config.dns === 'dnsmasq' && config.networking === 'macvlan') {
                    const dnsmasqContent = generateDnsmasqConf();
                    folder.file('dnsmasq/dnsmasq.conf', dnsmasqContent);
                }

                // Add instructions
                const instructions = generateInstructions();
                folder.file('SETUP_INSTRUCTIONS.md', instructions);

                // Generate ZIP file
                const blob = await zip.generateAsync({ type: 'blob' });

                // Download the ZIP
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'xcancel-config.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // Show success state
                button.innerHTML = '‚úì Downloaded!';
                button.style.background = '#52c41a';

                // Reset after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }, 2000);
            } catch (error) {
                console.error('Error creating ZIP:', error);
                button.innerHTML = '‚úó Failed - Try Individual Downloads';
                button.style.background = '#ff4d4f';
                button.disabled = false;

                // Reset after 3 seconds
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '#52c41a';
                }, 3000);
            }
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function copyStartCommand() {
            const button = event.target;
            const originalText = button.innerHTML;

            const cmd = 'docker compose up -d';

            navigator.clipboard.writeText(cmd).then(() => {
                button.innerHTML = '‚úì Copied!';
                button.style.background = '#52c41a';

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '#667eea';
                }, 2000);
            }).catch(() => {
                button.innerHTML = '‚úó Failed to Copy';
                button.style.background = '#ff4d4f';

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '#667eea';
                }, 2000);
            });
        }

        // Initialize
        updateProgress();

        // Set initial dnsmasq disabled state (disabled for bridge mode)
        if (config.networking !== 'macvlan') {
            const dnsmasqOption = document.getElementById('dnsmasqOption');
            dnsmasqOption.classList.add('disabled');
            dnsmasqOption.querySelector('input').disabled = true;
        }
    </script>
</body>
</html>
